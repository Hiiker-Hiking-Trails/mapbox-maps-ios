executor: xcode-latest
steps:
  - checkout-root
  - configure-environment:
      skip-dependencies: true
  - install-gh
  - run: brew upgrade gh
  - attach_workspace:
      at: workspace
  - run:
      name: Check API compatibility
      command: |
        export GITHUB_TOKEN=$(mbx-ci github issues private token)
        scripts/api-compatibility-check/breaking-api-check.py check-api workspace/baseline.api.json workspace/latest.api.json --breakage-allowlist-path scripts/api-compatibility-check/breakage_allowlist.txt --report-path api-compatibility-report.txt --comment-pr
  - run:
      name: Check private preview API compatibility if needed
      command: |
        if [ -f workspace/latest.private.api.json ]; then
            export GITHUB_TOKEN=$(mbx-ci github issues private token)
            scripts/api-compatibility-check/breaking-api-check.py check-api workspace/baseline.api.json workspace/latest.private.api.json --breakage-allowlist-path ../private/scripts/api-compatibility-check/breakage_allowlist.txt --report-path api-compatibility-report-private-preview.txt --comment-pr
        fi
  - store_artifacts:
      path: api-compatibility-report.txt
  - store_artifacts:
      path: api-compatibility-report-private-preview.txt
  - store-default-artifacts
