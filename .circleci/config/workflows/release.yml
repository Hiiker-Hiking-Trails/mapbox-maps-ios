jobs:
  - release-precheck:
      context:
        - Slack Orb
        - SDK Registry Token
      filters:
        tags:
          # Matches any release vX.Y.Z, but ignores -alpha releases
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - build-baseline-sdk:
      context:
        - Slack Orb
        - SDK Registry Token
      requires:
        - release-precheck
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - build-dynamic:
      check-api-breakage: true
      project-name: mobile-maps-ios
      context:
        - Slack Orb
        - SDK Registry Token
      requires:
        - release-precheck
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - build-static:
      context:
        - Slack Orb
        - SDK Registry Token
      requires:
        - release-precheck
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - build-docs:
      context:
        - Slack Orb
        - SDK Registry Token
      requires:
        - release-precheck
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - build-studio-preview:
      context:
        - Slack Orb
        - SDK Registry Token
      requires:
        - release-precheck
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - check-api-compatibility:
      context:
        - Slack Orb
      requires:
        - build-baseline-sdk
        - build-dynamic
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - create-registry-pr:
      project-name: mobile-maps-ios
      context:
        - Slack Orb
      requires:
        - build-static
        - build-docs
        - build-studio-preview
        - check-api-compatibility
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - wait-registry-pr:
      requires:
        - create-registry-pr
      type: approval
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - check-registry:
      project-name: mobile-maps-ios
      context:
        - Slack Orb
        - SDK Registry Token
      requires:
        - wait-registry-pr
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - create-docs-prs:
      context:
        - Slack Orb
      requires:
        - check-registry
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - update-examples:
      context:
        - Slack Orb
        - Fastlane Match
        - SDK Registry Token
        - Apple Machine account
        - Maps SDK/Public Mapbox Token
      requires:
        - check-registry
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - publish-podspec:
      context:
        - Slack Orb
        - CocoaPods trunk token
        - SDK Registry Token
      requires:
        - check-registry
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - validate-integrations:
      context:
        - Slack Orb
        - SDK Registry Token
      requires:
        - publish-podspec
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
  - create-draft-release:
      context:
        - Slack Orb
      requires:
        - create-docs-prs
        - update-examples
        - validate-integrations
      filters:
        tags:
          only: /^v[0-9]+\.[0-9]+\.[0-9]+(?!-alpha).*/
        branches:
          ignore: /.*/
