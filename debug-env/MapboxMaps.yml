---
name: MapboxMaps
options:
  bundleIdPrefix: com.mapbox
  settingPresets: project
  deploymentTarget:
    iOS: 11.0
settings:
  DEVELOPMENT_TEAM: GJZR2MEM28
  TARGETED_DEVICE_FAMILY: 1,2
projectReferences:
  Turf:
    path: "build/turf-swift/Turf.xcodeproj"
  MME:
    path: "build/mapbox-events-ios/MapboxMobileEvents.xcodeproj"
  MapboxCoreMaps:
    path: "build/mapbox-gl-native-internal/build/ios/Mapbox GL Native.xcodeproj"
  CocoaImageHashing:
    path: "build/cocoaimagehashing/CocoaImageHashing.xcodeproj"
targets:
  MapboxMaps:
    type: framework
    platform: iOS
    settings:
      base:
        DYLIB_INSTALL_NAME_BASE: "@rpath"
        MACH_O_TYPE: mh_dylib
        DEFINES_MODULE: "YES"
        PRODUCT_NAME: $(TARGET_NAME:c99extidentifier)
    configFiles:
      Debug: build/${PROJECT}/Configurations/base.xcconfig
      Release: build/${PROJECT}/Configurations/base.xcconfig
    sources:
      - path: "build/${PROJECT}/Sources/MapboxMaps/"
    dependencies:
      - target: MapboxCoreMaps/MapboxCommon
      - target: MapboxCoreMaps/MapboxCoreMaps
      - target: Turf/Turf
      - target: MME/MapboxMobileEvents
    scheme:
      testTargets:
        - MapboxMapsTests

  MapboxMapsTests:
    type: bundle.unit-test
    platform: iOS
    settings:
      base:
        BUNDLE_LOADER: $(TEST_HOST)
        TEST_HOST: $(BUILT_PRODUCTS_DIR)/Examples.app/$(BUNDLE_EXECUTABLE_FOLDER_PATH)/Examples
    configFiles:
      Debug: build/${PROJECT}/Configurations/unitTests.xcconfig
      Release: build/${PROJECT}/Configurations/unitTests.xcconfig
    sources:
      - path: "build/${PROJECT}/Tests/MapboxMapsTests"
        excludes:
          - "Integration Tests/HTTP/HTTPIntegrationTests.swift"
    dependencies:
      - target: Examples
      - target: "CocoaImageHashing/CocoaImageHashing (iOS Framework)"
    postBuildScripts:
      - path: build/${PROJECT}/scripts/insert_access_token.sh
        name: Insert Mapbox Token
        inputFiles:
          - $(TARGET_BUILD_DIR)/$(INFOPLIST_PATH)

  MapboxMapsHTTPTests:
    type: bundle.unit-test
    platform: iOS
    settings:
      base:
        LD_RUNPATH_SEARCH_PATHS: "$(inherited) @executable_path/Frameworks @loader_path/Frameworks"
        BUNDLE_LOADER: $(TEST_HOST)
        TEST_HOST: $(BUILT_PRODUCTS_DIR)/Examples.app/$(BUNDLE_EXECUTABLE_FOLDER_PATH)/Examples
    configFiles:
      Debug: build/${PROJECT}/Configurations/unitTests.xcconfig
      Release: build/${PROJECT}/Configurations/unitTests.xcconfig
    sources:
      - path: "build/${PROJECT}/Tests/MapboxMapsTests"
        includes:
          - Integration Tests/HTTP/HTTPIntegrationTests.swift
          - Integration Tests/MapViewIntegrationTestCase.swift
          - Integration Tests/IntegrationTestCase.swift
          - Helpers/Bundle+MapboxMapsTests.swift
          - Helpers/String+FileSystemSafe.swift
          - Helpers/XCTestCase+GuardForMetalDevice.swift
          - Helpers/XCTestCase+MapboxAccessToken.swift
          - Helpers/XCTestCase+TemporaryCacheDirectory.swift
    dependencies:
      - target: Examples
      - target: "CocoaImageHashing/CocoaImageHashing (iOS Framework)"
    postBuildScripts:
      - path: build/${PROJECT}/scripts/insert_access_token.sh
        name: Insert Mapbox Token
        inputFiles:
          - $(TARGET_BUILD_DIR)/$(INFOPLIST_PATH)

  Examples:
    type: application
    platform: iOS
    settings:
      base:
        ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
        ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME: AccentColor
        LD_RUNPATH_SEARCH_PATHS: $(inherited) @executable_path/Frameworks
        SKIP_INSTALL: NO
    scheme:
      testTargets:
        - ExamplesTests
        - MapboxMapsTests
        - MapboxMapsHTTPTests
    sources:
      - path: build/${PROJECT}/Apps/Examples/Examples/
    dependencies:
      - target: MapboxCoreMaps/MapboxCommon
      - target: MapboxCoreMaps/MapboxCoreMaps
      - target: Turf/Turf
      - target: MME/MapboxMobileEvents
      - target: MapboxMaps
    postBuildScripts:
      - path: build/${PROJECT}/scripts/insert_access_token.sh
        name: Insert Mapbox access token

  ExamplesTests:
    type: bundle.unit-test
    platform: iOS
    settings:
      base:
        BUNDLE_LOADER: $(TEST_HOST)
        TEST_HOST: $(BUILT_PRODUCTS_DIR)/Examples.app/$(BUNDLE_EXECUTABLE_FOLDER_PATH)/Examples
    sources:
      - path: build/${PROJECT}/Apps/Examples/ExamplesTests/
    dependencies:
      - target: Examples

  StressTestApp:
    type: application
    platform: iOS
    settings:
      base:
        ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
        LD_RUNPATH_SEARCH_PATHS: $(inherited) @executable_path/Frameworks
    sources:
      - path: build/${PROJECT}/Apps/StressTest/StressTest/
    dependencies:
      - target: MapboxCoreMaps/MapboxCommon
      - target: MapboxCoreMaps/MapboxCoreMaps
      - target: Turf/Turf
      - target: MME/MapboxMobileEvents
      - target: MapboxMaps
    postBuildScripts:
      - path: build/${PROJECT}/scripts/insert_access_token.sh
        name: Insert Mapbox access token